{% extends 'website/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Header do Wizard -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-magic fa-4x text-primary mb-3"></i>
                        <h1 class="display-5 mb-2">Wizard de Configuração</h1>
                        <p class="lead text-muted">Configure sua empresa em poucos passos simples</p>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="progress mb-4" style="height: 8px;">
                        <div class="progress-bar bg-primary" style="width: {{ progress }}%"></div>
                    </div>
                    
                    <!-- Steps Indicator -->
                    <div class="row mb-4">
                        <div class="col-3">
                            <div class="step-indicator completed">
                                <div class="step-number">✓</div>
                                <div class="step-label">Informações Básicas</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="step-indicator completed">
                                <div class="step-number">✓</div>
                                <div class="step-label">Personalização</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="step-indicator completed">
                                <div class="step-number">✓</div>
                                <div class="step-label">Configuração</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="step-indicator active">
                                <div class="step-number">4</div>
                                <div class="step-label">Usuários</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulário do Passo 4 -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Passo 4: Criação de Usuários
                    </h5>
                </div>
                <div class="card-body">
                    <form id="wizardForm" onsubmit="salvarPasso4(event)">
                        <!-- Usuário Administrador -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-user-shield me-2"></i>
                                    Usuário Administrador Principal
                                </h6>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Importante:</strong> Este será o usuário principal com acesso total ao sistema.
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Nome Completo *</label>
                                            <input type="text" class="form-control" id="adminNome" 
                                                   placeholder="Seu nome completo" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Email *</label>
                                            <input type="email" class="form-control" id="adminEmail" 
                                                   placeholder="seu@email.com" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Senha *</label>
                                            <input type="password" class="form-control" id="adminSenha" 
                                                   placeholder="Mínimo 8 caracteres" required>
                                            <div class="form-text">Mínimo 8 caracteres, incluindo letras e números</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Confirmar Senha *</label>
                                            <input type="password" class="form-control" id="adminSenhaConfirm" 
                                                   placeholder="Digite a senha novamente" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Usuários Adicionais -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-user-plus me-2"></i>
                                    Usuários Adicionais (Opcional)
                                </h6>
                                <div id="usuariosAdicionais">
                                    <!-- Usuários serão adicionados aqui dinamicamente -->
                                </div>
                                <button type="button" class="btn btn-outline-primary" onclick="adicionarUsuario()">
                                    <i class="fas fa-plus me-2"></i>Adicionar Usuário
                                </button>
                            </div>
                        </div>

                        <!-- Configurações de Acesso -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-key me-2"></i>
                                    Configurações de Acesso
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Política de Senhas</label>
                                            <select class="form-select" id="politicaSenhas">
                                                <option value="padrao" selected>Padrão (8+ caracteres)</option>
                                                <option value="forte">Forte (12+ caracteres, símbolos)</option>
                                                <option value="muito_forte">Muito Forte (16+ caracteres)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Expiração de Senha</label>
                                            <select class="form-select" id="expiracaoSenha">
                                                <option value="0">Nunca</option>
                                                <option value="30">30 dias</option>
                                                <option value="90" selected>90 dias</option>
                                                <option value="180">180 dias</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="forcarTrocaSenha" checked>
                                                <label class="form-check-label" for="forcarTrocaSenha">
                                                    Forçar troca de senha no primeiro login
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="bloquearContas" checked>
                                                <label class="form-check-label" for="bloquearContas">
                                                    Bloquear contas após tentativas falhadas
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumo dos Usuários -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Resumo dos Usuários
                                    </h6>
                                    <div id="resumoUsuarios">
                                        <p class="mb-2"><strong>Administrador:</strong> <span id="resumoAdmin">Não definido</span></p>
                                        <p class="mb-2"><strong>Usuários Adicionais:</strong> <span id="resumoAdicionais">0 usuários</span></p>
                                        <p class="mb-0"><strong>Total:</strong> <span id="resumoTotal">1 usuário</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botões de Navegação -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="voltarPasso()">
                                <i class="fas fa-arrow-left me-2"></i>Voltar
                            </button>
                            <button type="submit" class="btn btn-danger btn-lg">
                                Finalizar Setup <i class="fas fa-check ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-indicator {
    text-align: center;
    padding: 10px;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.step-indicator.active {
    background-color: #f8d7da;
    border: 2px solid #dc3545;
}

.step-indicator.completed {
    background-color: #e3f2fd;
    border: 2px solid #2196f3;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #2196f3;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto 8px;
}

.step-indicator.active .step-number {
    background-color: #dc3545;
}

.step-label {
    font-size: 12px;
    font-weight: 500;
    color: #666;
}

.step-indicator.active .step-label {
    color: #721c24;
    font-weight: 600;
}

.btn-lg {
    padding: 12px 24px;
    font-size: 1.1rem;
}

.usuario-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f8f9fa;
}

.usuario-card .btn-remove {
    color: #dc3545;
    border: none;
    background: none;
    font-size: 1.2rem;
}

.form-check-input:checked {
    background-color: #dc3545;
    border-color: #dc3545;
}
</style>

<script>
let usuarioCount = 0;

function adicionarUsuario() {
    usuarioCount++;
    const container = document.getElementById('usuariosAdicionais');
    
    const usuarioHtml = `
        <div class="usuario-card" id="usuario-${usuarioCount}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Usuário ${usuarioCount}</h6>
                <button type="button" class="btn-remove" onclick="removerUsuario(${usuarioCount})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="usuario${usuarioCount}Nome" 
                               placeholder="Nome do usuário">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="usuario${usuarioCount}Email" 
                               placeholder="email@empresa.com">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Nível de Acesso</label>
                        <select class="form-select" id="usuario${usuarioCount}Nivel">
                            <option value="gerente">Gerente</option>
                            <option value="operador" selected>Operador</option>
                            <option value="visualizador">Visualizador</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Departamento</label>
                        <select class="form-select" id="usuario${usuarioCount}Departamento">
                            <option value="geral">Geral</option>
                            <option value="vendas">Vendas</option>
                            <option value="financeiro">Financeiro</option>
                            <option value="estoque">Estoque</option>
                            <option value="rh">Recursos Humanos</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', usuarioHtml);
    atualizarResumo();
}

function removerUsuario(id) {
    const elemento = document.getElementById(`usuario-${id}`);
    elemento.remove();
    atualizarResumo();
}

function salvarPasso4(event) {
    event.preventDefault();
    
    // Validar senhas
    const senha = document.getElementById('adminSenha').value;
    const senhaConfirm = document.getElementById('adminSenhaConfirm').value;
    
    if (senha !== senhaConfirm) {
        Swal.fire('Erro!', 'As senhas não coincidem.', 'error');
        return;
    }
    
    if (senha.length < 8) {
        Swal.fire('Erro!', 'A senha deve ter pelo menos 8 caracteres.', 'error');
        return;
    }
    
    // Coletar dados dos usuários adicionais
    const usuariosAdicionais = [];
    for (let i = 1; i <= usuarioCount; i++) {
        const elemento = document.getElementById(`usuario-${i}`);
        if (elemento) {
            const nome = document.getElementById(`usuario${i}Nome`).value;
            const email = document.getElementById(`usuario${i}Email`).value;
            const nivel = document.getElementById(`usuario${i}Nivel`).value;
            const departamento = document.getElementById(`usuario${i}Departamento`).value;
            
            if (nome && email) {
                usuariosAdicionais.push({
                    nome: nome,
                    email: email,
                    nivel: nivel,
                    departamento: departamento
                });
            }
        }
    }
    
    // Salvar dados no localStorage
    const dadosUsuarios = {
        admin: {
            nome: document.getElementById('adminNome').value,
            email: document.getElementById('adminEmail').value,
            senha: senha
        },
        usuariosAdicionais: usuariosAdicionais,
        politicaSenhas: document.getElementById('politicaSenhas').value,
        expiracaoSenha: document.getElementById('expiracaoSenha').value,
        forcarTrocaSenha: document.getElementById('forcarTrocaSenha').checked,
        bloquearContas: document.getElementById('bloquearContas').checked
    };
    
    localStorage.setItem('wizard_usuarios', JSON.stringify(dadosUsuarios));
    
    // Mostrar loading e finalizar
    Swal.fire({
        title: 'Finalizando Setup...',
        text: 'Configurando sistema com suas preferências',
        icon: 'info',
        showConfirmButton: false,
        timer: 3000
    }).then(() => {
        // Salvar todos os dados do wizard
        const dadosCompletos = {
            empresa: JSON.parse(localStorage.getItem('wizard_empresa') || '{}'),
            personalizacao: JSON.parse(localStorage.getItem('wizard_personalizacao') || '{}'),
            configuracao: JSON.parse(localStorage.getItem('wizard_configuracao') || '{}'),
            usuarios: dadosUsuarios
        };
        
        localStorage.setItem('wizard_completo', JSON.stringify(dadosCompletos));
        
        // Ir para página de conclusão
        window.location.href = '/sistema/wizard/?step=complete';
    });
}

function voltarPasso() {
    window.location.href = '/sistema/wizard/?step=3';
}

function atualizarResumo() {
    const adminNome = document.getElementById('adminNome').value || 'Não definido';
    const usuariosAdicionais = document.querySelectorAll('.usuario-card').length;
    const total = 1 + usuariosAdicionais;
    
    document.getElementById('resumoAdmin').textContent = adminNome;
    document.getElementById('resumoAdicionais').textContent = `${usuariosAdicionais} usuários`;
    document.getElementById('resumoTotal').textContent = `${total} usuário${total > 1 ? 's' : ''}`;
}

// Atualizar resumo quando dados mudarem
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('change', atualizarResumo);
        input.addEventListener('keyup', atualizarResumo);
    });
    
    // Carregar dados salvos
    const dadosUsuarios = JSON.parse(localStorage.getItem('wizard_usuarios') || '{}');
    if (dadosUsuarios.admin) {
        document.getElementById('adminNome').value = dadosUsuarios.admin.nome || '';
        document.getElementById('adminEmail').value = dadosUsuarios.admin.email || '';
        document.getElementById('politicaSenhas').value = dadosUsuarios.politicaSenhas || 'padrao';
        document.getElementById('expiracaoSenha').value = dadosUsuarios.expiracaoSenha || '90';
        document.getElementById('forcarTrocaSenha').checked = dadosUsuarios.forcarTrocaSenha !== false;
        document.getElementById('bloquearContas').checked = dadosUsuarios.bloquearContas !== false;
    }
    
    atualizarResumo();
});

// Incluir SweetAlert2
if (typeof Swal === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
    document.head.appendChild(script);
}
</script>
{% endblock %} 